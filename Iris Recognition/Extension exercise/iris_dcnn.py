import os
import torch
from torch import nn
from torch.utils.data import DataLoader, random_split
from torchvision.datasets import ImageFolder
from torchvision import transforms as T
from torchvision import models
from sklearn.decomposition import PCA
from sklearn import svm, metrics
from sklearn.svm import SVC
import numpy as np
from tqdm import tqdm

TRAIN_PERC = 0.75


def main(path):
    # input transformations
    image_transforms = T.Compose([T.Resize(256), T.CenterCrop(224), T.ToTensor()])

    # data loader
    mmu_data = ImageFolder(root=path, transform=image_transforms)

    # split data into train and test datasets
    no_of_samples = len(mmu_data.targets)
    train_len = int(TRAIN_PERC * no_of_samples)
    test_len = no_of_samples - train_len
    train_dataset, test_dataset = random_split(mmu_data, (train_len, test_len))

    # dataset loaders
    train_loader = DataLoader(dataset=train_dataset, shuffle=True, batch_size=1)
    test_loader = DataLoader(dataset=test_dataset, shuffle=False, batch_size=1)

    # load VGG with pretrained weights
    vgg = models.vgg16(pretrained=True)
    print("--- Original VGG-16:")
    print(vgg)

    # change the network classifier to the nn.Flatten layer
    vgg.classifier = nn.Sequential(nn.Flatten())
    print("--- Modified VGG-16:")
    print(vgg)

    # extract features using VGG-16 in eval mode - save them in a list
    vgg.eval()
    train_features = list()
    train_labels = list()
    test_features = list()
    test_labels = list()
    
    with torch.no_grad():
        for img, label in tqdm(train_loader):
            feat = vgg(img)
            feat_numpy = feat.squeeze().cpu().detach().numpy()
            train_features.append(feat_numpy)
            train_labels.append(label.numpy())

        for img, label in tqdm(test_loader):
            feat = vgg(img)
            feat_numpy = feat.squeeze().cpu().detach().numpy()
            test_features.append(feat_numpy)
            test_labels.append(label.numpy())

    # Convert the train and test labels to 1D arrays
    train_labels = np.ravel(train_labels)
    test_labels = np.ravel(test_labels)

    # Perform PCA decomposition on the train features
    pca = PCA(n_components=150)
    train_features_pca = pca.fit_transform(train_features)

    # Transform the test features using the trained PCA object
    test_features_pca = pca.transform(test_features)

    # Train an SVM classifier on the train features and labels
    svm = SVC(kernel='rbf')
    svm.fit(train_features_pca, train_labels)

    # Predict the labels of the test features using the trained SVM
    Y_predict = svm.predict(test_features_pca)

    # print metrics
    print(metrics.classification_report(test_labels, Y_predict))


if __name__ == "__main__":
    path_mmu = './MMU_dataset' #insert path to the mmu dataset
    main(path_mmu)

# PCA : 50
#             precision    recall  f1-score   support

#            0       1.00      1.00      1.00         2
#            2       1.00      1.00      1.00         2
#            3       1.00      1.00      1.00         1
#            4       0.00      0.00      0.00         1
#            5       1.00      0.50      0.67         2
#            7       1.00      1.00      1.00         2
#            8       0.20      1.00      0.33         1
#            9       1.00      1.00      1.00         2
#           10       1.00      1.00      1.00         2
#           11       1.00      0.50      0.67         2
#           12       0.50      1.00      0.67         2
#           13       1.00      1.00      1.00         1
#           14       1.00      0.33      0.50         3
#           15       0.00      0.00      0.00         3
#           16       1.00      1.00      1.00         2
#           17       1.00      1.00      1.00         1
#           18       1.00      1.00      1.00         1
#           19       1.00      1.00      1.00         1
#           21       1.00      0.50      0.67         2
#           23       1.00      1.00      1.00         1
#           24       1.00      1.00      1.00         2
#           26       1.00      0.33      0.50         3
#           28       1.00      1.00      1.00         1
#           29       1.00      1.00      1.00         2
#           30       0.00      0.00      0.00         0
#           31       1.00      1.00      1.00         1
#           32       0.00      0.00      0.00         1
#           33       1.00      0.67      0.80         3
#           34       0.50      1.00      0.67         1
#           36       0.50      0.50      0.50         2
#           37       1.00      1.00      1.00         2
#           38       1.00      1.00      1.00         1
#           39       0.00      0.00      0.00         0
#           40       0.50      1.00      0.67         1
#           41       1.00      1.00      1.00         1
#           42       0.33      1.00      0.50         1
#           43       0.20      1.00      0.33         1
#           44       1.00      1.00      1.00         1
#           46       1.00      1.00      1.00         1
#           47       0.00      0.00      0.00         0
#           48       1.00      1.00      1.00         2
#           49       0.00      0.00      0.00         2
#           50       0.67      1.00      0.80         2
#           52       0.00      0.00      0.00         2
#           53       0.00      0.00      0.00         0
#           54       0.00      0.00      0.00         0
#           55       0.00      0.00      0.00         0
#           56       0.67      1.00      0.80         2
#           57       0.00      0.00      0.00         3
#           58       0.00      0.00      0.00         0
#           59       0.50      1.00      0.67         1
#           60       1.00      0.50      0.67         2
#           61       1.00      1.00      1.00         1
#           62       1.00      1.00      1.00         2
#           63       1.00      0.50      0.67         2
#           64       0.33      0.50      0.40         2
#           65       0.00      0.00      0.00         3
#           67       0.33      1.00      0.50         1
#           69       1.00      1.00      1.00         1
#           70       0.00      0.00      0.00         4
#           71       0.00      0.00      0.00         0
#           72       0.00      0.00      0.00         1
#           73       1.00      1.00      1.00         1
#           74       0.00      0.00      0.00         2
#           75       0.00      0.00      0.00         1
#           76       1.00      1.00      1.00         3
#           77       1.00      1.00      1.00         3
#           79       1.00      1.00      1.00         1
#           80       0.50      1.00      0.67         1
#           81       0.00      0.00      0.00         1
#           82       0.00      0.00      0.00         2
#           84       1.00      1.00      1.00         1
#           85       1.00      1.00      1.00         1
#           86       0.00      0.00      0.00         0
#           87       1.00      1.00      1.00         1
#           88       1.00      1.00      1.00         2
#           89       1.00      1.00      1.00         1

#     accuracy                           0.66       113
#    macro avg       0.62      0.65      0.61       113
# weighted avg       0.68      0.66      0.64       113

# PCA : 100
#         precision    recall  f1-score   support

#            0       0.50      1.00      0.67         1
#            1       0.00      0.00      0.00         0
#            2       1.00      1.00      1.00         1
#            3       1.00      1.00      1.00         1
#            4       0.50      1.00      0.67         1
#            5       0.50      1.00      0.67         1
#            6       0.00      0.00      0.00         3
#            7       1.00      1.00      1.00         1
#            8       1.00      1.00      1.00         1
#            9       1.00      1.00      1.00         1
#           10       1.00      1.00      1.00         1
#           13       1.00      1.00      1.00         2
#           14       1.00      1.00      1.00         1
#           16       1.00      1.00      1.00         2
#           18       1.00      1.00      1.00         2
#           19       0.50      1.00      0.67         1
#           20       0.00      0.00      0.00         3
#           21       0.17      1.00      0.29         1
#           22       1.00      1.00      1.00         1
#           25       1.00      1.00      1.00         1
#           26       0.67      1.00      0.80         2
#           27       0.00      0.00      0.00         4
#           28       1.00      0.67      0.80         3
#           30       1.00      1.00      1.00         1
#           31       1.00      1.00      1.00         1
#           32       1.00      1.00      1.00         2
#           35       0.00      0.00      0.00         0
#           36       0.50      1.00      0.67         1
#           37       0.00      0.00      0.00         0
#           38       1.00      1.00      1.00         1
#           39       1.00      1.00      1.00         2
#           40       1.00      1.00      1.00         1
#           41       1.00      0.67      0.80         3
#           42       0.33      0.50      0.40         2
#           43       0.33      1.00      0.50         1
#           44       0.00      0.00      0.00         3
#           45       1.00      1.00      1.00         2
#           47       1.00      1.00      1.00         2
#           48       0.33      1.00      0.50         1
#           49       0.00      0.00      0.00         3
#           50       1.00      0.33      0.50         3
#           51       1.00      1.00      1.00         1
#           52       0.50      1.00      0.67         1
#           53       0.50      1.00      0.67         1
#           54       1.00      0.50      0.67         2
#           55       0.40      1.00      0.57         2
#           57       0.50      1.00      0.67         1
#           58       1.00      0.50      0.67         2
#           59       1.00      1.00      1.00         1
#           60       1.00      0.50      0.67         2
#           62       1.00      1.00      1.00         2
#           63       1.00      1.00      1.00         1
#           66       1.00      1.00      1.00         1
#           67       1.00      0.50      0.67         2
#           68       1.00      1.00      1.00         1
#           69       1.00      1.00      1.00         1
#           70       1.00      1.00      1.00         1
#           71       1.00      1.00      1.00         2
#           72       0.00      0.00      0.00         1
#           74       1.00      0.50      0.67         2
#           75       0.00      0.00      0.00         2
#           76       1.00      1.00      1.00         1
#           77       1.00      1.00      1.00         3
#           78       1.00      0.67      0.80         3
#           80       1.00      1.00      1.00         1
#           81       0.00      0.00      0.00         0
#           82       0.00      0.00      0.00         0
#           83       1.00      0.67      0.80         3
#           84       0.67      1.00      0.80         2
#           85       1.00      1.00      1.00         2
#           86       1.00      1.00      1.00         1
#           87       1.00      1.00      1.00         1
#           88       1.00      0.50      0.67         2
#           89       0.50      1.00      0.67         1

#     accuracy                           0.72       113
#    macro avg       0.72      0.76      0.71       113
# weighted avg       0.74      0.72      0.69       113

# PCA : 25
#        precision    recall  f1-score   support

#            1       1.00      1.00      1.00         1
#            2       1.00      0.33      0.50         3
#            3       0.40      1.00      0.57         2
#            4       0.00      0.00      0.00         1
#            5       0.33      1.00      0.50         1
#            6       1.00      0.50      0.67         2
#            7       1.00      1.00      1.00         1
#            8       0.14      1.00      0.25         1
#           10       0.00      0.00      0.00         0
#           12       0.00      0.00      0.00         1
#           13       0.50      1.00      0.67         1
#           14       0.50      1.00      0.67         2
#           15       0.00      0.00      0.00         3
#           16       0.00      0.00      0.00         3
#           17       0.50      1.00      0.67         1
#           18       1.00      1.00      1.00         1
#           20       1.00      1.00      1.00         1
#           21       0.00      0.00      0.00         2
#           22       0.50      0.50      0.50         2
#           23       0.00      0.00      0.00         1
#           24       1.00      1.00      1.00         1
#           27       1.00      0.50      0.67         2
#           28       0.50      1.00      0.67         1
#           29       0.00      0.00      0.00         2
#           30       0.00      0.00      0.00         3
#           31       0.00      0.00      0.00         3
#           32       0.00      0.00      0.00         3
#           33       0.00      0.00      0.00         2
#           35       1.00      0.33      0.50         3
#           36       0.00      0.00      0.00         1
#           37       0.00      0.00      0.00         0
#           38       1.00      1.00      1.00         1
#           40       0.33      1.00      0.50         1
#           42       0.00      0.00      0.00         1
#           43       0.00      0.00      0.00         1
#           44       1.00      1.00      1.00         1
#           45       0.00      0.00      0.00         0
#           46       1.00      1.00      1.00         2
#           47       0.00      0.00      0.00         0
#           49       0.00      0.00      0.00         0
#           50       1.00      1.00      1.00         1
#           51       0.00      0.00      0.00         3
#           53       0.00      0.00      0.00         0
#           54       0.50      1.00      0.67         1
#           55       0.50      0.50      0.50         2
#           56       0.67      1.00      0.80         2
#           57       0.00      0.00      0.00         1
#           58       0.00      0.00      0.00         0
#           59       1.00      1.00      1.00         1
#           61       1.00      1.00      1.00         1
#           62       0.00      0.00      0.00         3
#           63       0.50      1.00      0.67         1
#           64       0.00      0.00      0.00         3
#           65       0.67      0.67      0.67         3
#           66       1.00      1.00      1.00         1
#           67       0.00      0.00      0.00         3
#           68       0.25      0.50      0.33         2
#           69       0.00      0.00      0.00         4
#           70       1.00      1.00      1.00         1
#           71       0.25      1.00      0.40         1
#           72       0.00      0.00      0.00         2
#           74       0.00      0.00      0.00         1
#           75       0.00      0.00      0.00         4
#           76       1.00      1.00      1.00         1
#           77       1.00      1.00      1.00         1
#           79       1.00      0.50      0.67         2
#           80       0.00      0.00      0.00         1
#           81       1.00      1.00      1.00         1
#           82       1.00      1.00      1.00         1
#           83       0.00      0.00      0.00         0
#           84       0.00      0.00      0.00         0
#           85       1.00      1.00      1.00         1
#           86       0.00      0.00      0.00         0
#           87       1.00      0.33      0.50         3
#           88       1.00      0.50      0.67         2
#           89       0.50      1.00      0.67         1

#     accuracy                           0.42       113
#    macro avg       0.43      0.48      0.42       113
# weighted avg       0.42      0.42      0.38       113

PCA : 150
#            0       0.00      0.00      0.00         0
#            1       1.00      1.00      1.00         2
#            2       1.00      1.00      1.00         1
#            4       1.00      1.00      1.00         1
#            5       0.00      0.00      0.00         0
#            6       1.00      1.00      1.00         1
#            7       1.00      1.00      1.00         2
#           10       1.00      1.00      1.00         1
#           11       1.00      1.00      1.00         2
#           12       0.00      0.00      0.00         1
#           13       0.00      0.00      0.00         2
#           14       1.00      1.00      1.00         2
#           15       0.00      0.00      0.00         0
#           16       1.00      1.00      1.00         2
#           17       1.00      1.00      1.00         1
#           18       1.00      1.00      1.00         1
#           20       1.00      1.00      1.00         1
#           21       0.67      1.00      0.80         2
#           22       0.50      1.00      0.67         2
#           23       1.00      0.50      0.67         2
#           24       1.00      1.00      1.00         2
#           25       1.00      0.67      0.80         3
#           27       1.00      1.00      1.00         2
#           28       1.00      1.00      1.00         1
#           30       1.00      1.00      1.00         2
#           32       0.00      0.00      0.00         0
#           34       1.00      1.00      1.00         3
#           35       1.00      1.00      1.00         1
#           36       0.00      0.00      0.00         2
#           37       0.17      1.00      0.29         1
#           38       1.00      1.00      1.00         2
#           39       0.33      1.00      0.50         1
#           40       1.00      1.00      1.00         1
#           41       0.50      1.00      0.67         1
#           42       0.00      0.00      0.00         0
#           43       0.00      0.00      0.00         2
#           44       1.00      0.50      0.67         2
#           45       0.00      0.00      0.00         3
#           46       1.00      1.00      1.00         1
#           47       1.00      1.00      1.00         1
#           48       0.50      1.00      0.67         1
#           49       1.00      1.00      1.00         1
#           50       1.00      1.00      1.00         1
#           51       1.00      1.00      1.00         2
#           52       0.00      0.00      0.00         1
#           53       0.00      0.00      0.00         0
#           54       1.00      1.00      1.00         2
#           55       1.00      1.00      1.00         1
#           56       0.50      1.00      0.67         1
#           57       0.00      0.00      0.00         2
#           58       1.00      0.50      0.67         2
#           60       1.00      1.00      1.00         3
#           61       1.00      1.00      1.00         2
#           62       1.00      1.00      1.00         1
#           63       1.00      1.00      1.00         1
#           64       1.00      1.00      1.00         1
#           66       0.00      0.00      0.00         1
#           67       0.50      1.00      0.67         1
#           68       1.00      0.33      0.50         3
#           70       1.00      1.00      1.00         2
#           71       1.00      1.00      1.00         1
#           72       1.00      1.00      1.00         1
#           73       1.00      0.50      0.67         2
#           75       0.00      0.00      0.00         1
#           76       0.00      0.00      0.00         4
#           77       0.25      1.00      0.40         1
#           78       1.00      0.67      0.80         3
#           79       0.00      0.00      0.00         4
#           81       1.00      1.00      1.00         1
#           83       1.00      1.00      1.00         1
#           84       0.50      1.00      0.67         1
#           85       1.00      1.00      1.00         3
#           86       0.00      0.00      0.00         3
#           89       1.00      1.00      1.00         1

#     accuracy                           0.70       113
#    macro avg       0.68      0.71      0.67       113
# weighted avg       0.71      0.70      0.68       113